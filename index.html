<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add / Edit Employee</title>
    <link rel="stylesheet" href="estilo.css">
</head>
<body>

    <nav>
        <div class="logo">Employees</div>
        <div class="nav-links">
            <a href="index.html" class="active">Add</a>
            <a href="employees.html">Employees</a>
            <a href="#" class="btn-contact">Contact</a>
        </div>
    </nav>

    <main>
        <section class="form-container">
            <div class="input-group">
                <label>Name</label>
                <input type="text" id="nome" placeholder="Type the employee's name.">
            </div>

            <div class="input-group">
                <label>Age</label>
                <input type="number" id="idade" placeholder="Type his age.">
            </div>

            <div class="input-group">
                <label>Country</label>
                <input type="text" id="pais" placeholder="Tell us his country.">
            </div>

            <div class="input-group">
                <label>Job</label>
                <input type="text" id="trabalho" placeholder="What is his job?">
            </div>

            <div class="input-group">
                <label>Wage (Year)</label>
                <input type="number" id="salario" placeholder="Type his yearly wage.">
            </div>

            <button class="btn-add">Add employee</button>
            <button class="btn-cancel" style="display:none; background: #ccc; margin-top: 10px;" onclick="cancelarEdicao()">Cancel</button>
        </section>
    </main>

    <footer>
        All rights reserved.
    </footer>

    <script>
    const btnAdd = document.querySelector('.btn-add');
    const btnCancel = document.querySelector('.btn-cancel');
    const idParaEditar = localStorage.getItem('idParaEditar');
    const portaApi = "7083"; // Verifique se sua porta no VS é esta
    
    let dadosOriginais = {}; // Guarda os dados para comparar e garantir o envio completo

    // Inicialização: Modo Edição ou Cadastro
    if (idParaEditar) {
        btnAdd.innerText = "Update employee";
        btnCancel.style.display = "block";
        carregarDadosParaEdicao(idParaEditar);
    }

    // Busca os dados atuais do banco para preencher o form
    async function carregarDadosParaEdicao(id) {
        try {
            const response = await fetch(`https://localhost:${portaApi}/api/Funcionarios/${id}`);
            if (response.ok) {
                const f = await response.json();
                dadosOriginais = { ...f }; // Salva a cópia exata do que está no banco
                
                document.getElementById('nome').value = f.nome;
                document.getElementById('idade').value = f.idade;
                document.getElementById('pais').value = f.pais;
                document.getElementById('trabalho').value = f.trabalho;
                document.getElementById('salario').value = f.salarioAnual;
            }
        } catch (error) {
            console.error("Erro ao carregar dados:", error);
        }
    }

    btnAdd.addEventListener('click', async () => {
        // Captura os valores atuais dos inputs
        const nomeValor = document.getElementById('nome').value;
        const idadeValor = document.getElementById('idade').value;
        const paisValor = document.getElementById('pais').value;
        const trabalhoValor = document.getElementById('trabalho').value;
        const salarioValor = document.getElementById('salario').value;

        // 1. VALIDAÇÃO: CAMPOS OBRIGATÓRIOS NO CADASTRO
        if (!idParaEditar) {
            if (!nomeValor || !idadeValor || !paisValor || !trabalhoValor || !salarioValor) {
                alert("Todos os campos são obrigatórios para o cadastro!");
                return;
            }
        } 
        // 2. VALIDAÇÃO: PELO MENOS UMA MUDANÇA NA EDIÇÃO
        else {
            const houveMudanca = 
                nomeValor !== dadosOriginais.nome ||
                parseInt(idadeValor) !== dadosOriginais.idade ||
                paisValor !== dadosOriginais.pais ||
                trabalhoValor !== dadosOriginais.trabalho ||
                parseFloat(salarioValor) !== dadosOriginais.salarioAnual;

            if (!houveMudanca) {
                alert("Você deve alterar pelo menos um campo para atualizar!");
                return;
            }
        }

        // Monta o objeto completo (garante que campos não editados mantenham o valor original)
        const funcionarioParaEnviar = {
            id: idParaEditar ? parseInt(idParaEditar) : 0,
            nome: nomeValor,
            idade: parseInt(idadeValor),
            pais: paisValor,
            trabalho: trabalhoValor,
            salarioAnual: parseFloat(salarioValor)
        };

        const url = idParaEditar 
            ? `https://localhost:${portaApi}/api/Funcionarios/${idParaEditar}`
            : `https://localhost:${portaApi}/api/Funcionarios`;
        
        const metodo = idParaEditar ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: metodo,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(funcionarioParaEnviar)
            });

            if (response.ok) {
                alert(idParaEditar ? "Employee updated!" : "Employee added!");
                localStorage.removeItem('idParaEditar');
                window.location.href = "employees.html";
            } else {
                const erroTexto = await response.text();
                console.error("Erro da API:", erroTexto);
                alert("Erro ao salvar. Verifique se os dados estão corretos.");
            }
        } catch (error) {
            console.error("Erro na requisição:", error);
            alert("Não foi possível conectar à API.");
        }
    });

    function cancelarEdicao() {
        localStorage.removeItem('idParaEditar');
        window.location.href = "employees.html";
    }
</script>
</body>
</html>